import java.awt.EventQueue;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.WindowEvent;

import javax.swing.JButton;

import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPasswordField;
import javax.swing.JTextField;

import java.sql.ResultSet;
import database_management.MySQLdbManager;
import md5_calculator.Md5hashcalc;

public class operatorUserSettingsWindow extends JFrame {

	private final JLabel usernameLabel = new JLabel();
	private final JLabel passwordLabel = new JLabel();
	private final JLabel passwordAgainLabel = new JLabel();
	private final JLabel nameLabel = new JLabel();
	private final JLabel lastNameLabel = new JLabel();
	private final JButton updateButton = new JButton();
	private final JTextField firstNameTextField = new JTextField();
	private final JTextField lastNameTextField = new JTextField();
	private final JPasswordField passwordPasswordField = new JPasswordField();
	private final JPasswordField passwordAgainPasswordField = new JPasswordField();
	
	private String currentOperatorPassword = "";
	public static String operatorFirstNameLastNameCombination = "";
	
	/**
	 * Launch the application
	 * @param args
	 */
	public static void main(String args[]) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					operatorUserSettingsWindow frame = new operatorUserSettingsWindow();
					frame.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	/**
	 * Create the frame
	 */
	public operatorUserSettingsWindow() {
		super();
		setBounds(100, 100, 314, 214);
		setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
		try {
			jbInit();
		} catch (Throwable e) {
			e.printStackTrace();
		}
		//
	}
	private void jbInit() throws Exception {
		getContentPane().setLayout(null);
		setResizable(false);
		setAlwaysOnTop(true);
		setTitle("Настройки на потребител");
		setName("operatorUserSettings");
		
		getContentPane().add(usernameLabel);
		usernameLabel.setText("Потребител:");
		usernameLabel.setBounds(10, 0, 278, 16);
		
		getContentPane().add(passwordLabel);
		passwordLabel.setText("Парола:");
		passwordLabel.setBounds(10, 76, 97, 16);
		
		getContentPane().add(passwordAgainLabel);
		passwordAgainLabel.setText("Парола отново:");
		passwordAgainLabel.setBounds(10, 95, 97, 16);
		
		getContentPane().add(nameLabel);
		nameLabel.setText("Име:");
		nameLabel.setBounds(10, 32, 97, 16);
		
		getContentPane().add(lastNameLabel);
		lastNameLabel.setText("Фамилия:");
		lastNameLabel.setBounds(10, 54, 97, 16);
		
		getContentPane().add(updateButton);
		updateButton.addActionListener(new UpdateButtonActionListener());
		updateButton.setText("Обнови");
		updateButton.setBounds(93, 140, 106, 26);
		
		getContentPane().add(firstNameTextField);
		firstNameTextField.setBounds(113, 30, 175, 20);
		
		getContentPane().add(lastNameTextField);
		lastNameTextField.setBounds(113, 52, 175, 20);
		
		getContentPane().add(passwordPasswordField);
		passwordPasswordField.setBounds(113, 74, 175, 20);
		
		getContentPane().add(passwordAgainPasswordField);
		passwordAgainPasswordField.setBounds(113, 97, 175, 20);
		
		getCurrentUserData();
	}
	
	private void getCurrentUserData() {
		
		if (databaseConnectWindow.dbPortal == null) {
			return;
		}
		if (databaseConnectWindow.dbPortal.isConnected() == false) {
			return;
		}
		if (operatorUserLoginWindow.loggedUserId == -1) {
			return;
		}
		
		ResultSet rs = databaseConnectWindow.dbPortal.executeQuery("SELECT operator_username, operator_password, " + 
				"operator_first_name, operator_last_name FROM operators WHERE operator_id=" + operatorUserLoginWindow.loggedUserId);
		
		if ((rs == null) || (databaseConnectWindow.dbPortal.getLastError() != null)) {
			return;
		}
		
		try {
			
			usernameLabel.setText("Потребител: " + rs.getString(1));
			currentOperatorPassword = rs.getString(2);
			firstNameTextField.setText(rs.getString(3));
			lastNameTextField.setText(rs.getString(4));
		}
		catch (Exception ex) {			
		}
		
		operatorFirstNameLastNameCombination = firstNameTextField.getText() + " " + lastNameTextField.getText();
	}
	
	private class UpdateButtonActionListener implements ActionListener {
		public void actionPerformed(ActionEvent e) {
			updateButton_actionPerformed(e);
		}
	}
	protected void updateButton_actionPerformed(ActionEvent e) {
		
		char[] pass = passwordPasswordField.getPassword();
		String password = "";
		
		for (int i = 0; i < pass.length; i++) {
			
			password += pass[i];
		}
		
		char[] pass2 = passwordAgainPasswordField.getPassword();
		String password2 = "";
		
		for (int j = 0; j < pass2.length; j++) {
			
			password2 += pass2[j];
		}
		
		if (password != password2) {
			
			JOptionPane.showMessageDialog(this, "Паролите не съвпадат!", "Грешка при промяна на парола", JOptionPane.ERROR_MESSAGE);
			return;
		}
		
		if (password.length() > 3) { //password update will be performed too
			
			try {
				
				password = Md5hashcalc.calculateMD5hash(password);
				currentOperatorPassword = password;
			}
			catch (Exception ex) {
				
				JOptionPane.showMessageDialog(this, "Данните с изключение на тези за паролата само\nще бъдат обновени поради проблеми с криптирането!", "Проблем при промяна на парола", JOptionPane.ERROR_MESSAGE);
			}			
		}
		else {
			if (password.length() > 0) {
				
				JOptionPane.showMessageDialog(this, "Паролата трябва да е поне 4 символа!", "Грешка при промяна на парола", JOptionPane.ERROR_MESSAGE);
				return;
			}
		}
		
		if ((firstNameTextField.getText().length() <= 3) || (lastNameTextField.getText().length() <= 3)) {
			
			JOptionPane.showMessageDialog(this, "Прекалено кратки име или фамилия!", "Грешка при обновяването", JOptionPane.ERROR_MESSAGE);
			return;
		}
		
		//FIXME prone to sql injection
		if (databaseConnectWindow.dbPortal.executeNonQuery("UPDATE operators SET operator_password='" + currentOperatorPassword +
				"', operator_first_name='" + firstNameTextField.getText() + "', operator_last_name='" + 
				lastNameTextField.getText() + "'") != 1) {
			
			JOptionPane.showMessageDialog(this, "Грешка при обновяване на данните!", "Грешка при обновяването", JOptionPane.ERROR_MESSAGE);
			return;
		}
		
		operatorFirstNameLastNameCombination = firstNameTextField.getText() + lastNameTextField.getText();
		
		this.getToolkit().getSystemEventQueue().postEvent(new WindowEvent(this, WindowEvent.WINDOW_CLOSING));		
	}

}
