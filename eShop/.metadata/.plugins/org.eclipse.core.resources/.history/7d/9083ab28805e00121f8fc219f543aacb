/*
 * Easy JTable population amd management with data from database.
 * (C) 14.01.2013 - zhgzhg
 */

package tables_management;

import database_management.MySQLdbManager;
import java.sql.ResultSet;

import javax.swing.JOptionPane;
import javax.swing.table.AbstractTableModel;

public class Tables_db_manager {
	
	private AbstractTableModel currentModel;
	private int rowsCount, columnsCount;
	private String populateQuery = null, insertQuery = null, updateQuery = null, deleteQuery = null;
	private Object[] populateQueryParams = null, insertQueryParams = null, updateQueryParams = null, deleteQueryParams = null;
	
	private boolean noDataInTheCells = true;
	private String[][] noDataInTheCellsMessage = null;
	
	private MySQLdbManager dbPortal;
	private String errorMessage = null;
	
	private String[][] CELLS;
	
	public Tables_db_manager(AbstractTableModel tableModelPointer, int rowsCount, int columnsCount, 
			MySQLdbManager openedDatabasePointer, String[][] CELLS) {
		
		this.currentModel = tableModelPointer;
		this.rowsCount = rowsCount;
		this.columnsCount = columnsCount;
		this.dbPortal = openedDatabasePointer;
		this.CELLS = CELLS;
	}
	
	public void setPopulateQuery(String query) {
		
		populateQuery = query;
		populateQueryParams = null;
	}
	
	public void setPopulateQuery(String query, Object... params) {
		
		populateQuery = query;
		populateQueryParams = new Object[params.length];
		
		for (int i = 0; i < params.length; i++) {
			populateQueryParams[i] = params[i];
		}
	}
	
	public void setInsertQuery(String query) {
		
		insertQuery = query;
		insertQueryParams = null;
	}
	
	public void setInsertQuery(String query, Object... params) {
		
		insertQuery = query;
		insertQueryParams = new Object[params.length];
		
		for (int i = 0; i < params.length; i++) {
			insertQueryParams[i] = params[i];
		}
	}
	
	public void setUpdateQuery(String query) {
		
		updateQuery = query;
		updateQueryParams = null;
	}
	
	public void setUpdateQuery(String query, Object... params) {
		
		updateQuery = query;
		updateQueryParams = new Object[params.length];
		
		for (int i = 0; i < params.length; i++) {
			updateQueryParams[i] = params[i];
		}
	}
	
	public void setDeleteQuery(String query) {
		
		deleteQuery = query;
		deleteQueryParams = null;
	}
	
	public void setDeleteQuery(String query, Object... params) {
		
		deleteQuery = query;
		deleteQueryParams = new Object[params.length];
		
		for (int i = 0; i < params.length; i++) {
			deleteQueryParams[i] = params[i];
		}
	}

	public void setNoDataInTheCellsMessage(String[] wordsToPutInTheCells) {
		
		noDataInTheCellsMessage = new String[1][wordsToPutInTheCells.length];
		
		for (int i = 0; i < wordsToPutInTheCells.length; i++) {
			noDataInTheCellsMessage[0][i] = wordsToPutInTheCells[i];
		}
	}
	
	public String[][] performPopulate() {
		
		ResultSet rs = null;
				
		if (populateQueryParams == null) { 
			rs = dbPortal.executeQuery(populateQuery); 
		}
		else {
			rs = dbPortal.executeParameterizedQuery(populateQuery, populateQueryParams);
		}
		
		if (rs != null) {
			
			try {
			
				rs.last();
				rowsCount = rs.getRow();
				if (rowsCount <= 0) {					
					return CELLS;
				}
				rs.first();
				
				CELLS = new String[rowsCount][columnsCount];
				
				while (true) {
					
					for (int j = 0; j < columnsCount; j++) {						
					
						CELLS[rs.getRow() - 1][j] = rs.getObject(j + 1).toString();
					}
					
					if (rs.isLast()) {
						break;
					}
					
					rs.next();
				}
				
				noDataInTheCells = false;					
			}
			catch (Exception ex) {
				
			}				
		}
		
		return CELLS;
	}
	
	public String[][] performInsert() {
		
		errorMessage = null;
		
		ResultSet rs = null;
		
		if (populateQueryParams == null) {
		
			if (dbPortal.executeNonQuery(insertQuery) != 1) {
				
				errorMessage = "Грешка при добавянето на продукт:\n" + dbPortal.getLastError();				
				return CELLS;
			}		
		}
		else {
			
			if (dbPortal.executeParameterizedNonQuery(insertQuery, insertQueryParams) != 1) {
				
				errorMessage = "Грешка при добавянето на продукт:\n" + dbPortal.getLastError();				
				return CELLS;
			}			
		}
		
		// populate the table with the new row
		
		int lastProductId = -1;
		
		//ResultSet rs = dbPortal.executeParameterizedQuery("SELECT product_id FROM products WHERE product_name=? AND " +
			//	"product_quantity=? AND product_price=? ORDER BY product_id DESC", name, quantity, price);
		rs = dbPortal.executeQuery("SELECT LAST_INSERT_ID()");
		
		if (rs != null) {
			
			try {
				lastProductId = rs.getInt(1);
			}
			catch (Exception ex) {
				lastProductId = -1;
			}
		}
		
		if (lastProductId == -1) {
			errorMessage = "Грешка при опресняването на таблицата с продукти!";
			return CELLS;
		}
		
		String[][] newCells = null;
		
		if (noDataInTheCells == false) {
		
			newCells = new String[CELLS.length + 1][4];
			for (int i = 0; i < CELLS.length; i++) {
				newCells[i][0] = CELLS[i][0];
				newCells[i][1] = CELLS[i][1];
				newCells[i][2] = CELLS[i][2];
				newCells[i][3] = CELLS[i][3];
			}
		}
		else {				
			newCells = new String[1][columnsCount];	
		}
		
		rs = null;
		rs = dbPortal.executeQuery(populateQuery + lastProductId); //special query
		
		if (rs != null) {
			
			try {
				
				for (int k = 0; k < columnsCount; k++) {
					newCells[(noDataInTheCells == false ? CELLS.length : 0)][k] = 
				}
				//newCells[(noDataInTheCells == false ? CELLS.length : 0)][0] = rs.getString(2);			   // product_name
				//newCells[(noDataInTheCells == false ? CELLS.length : 0)][1] = new String("" + rs.getInt(3)); // product_quantity
				//newCells[(noDataInTheCells == false ? CELLS.length : 0)][2] = rs.getBigDecimal(4).toString();// product_price
				//newCells[(noDataInTheCells == false ? CELLS.length : 0)][3] = new String("" + rs.getInt(1)); // product_id
			}
			catch (Exception ex) {
				
				errorMessage = "Грешка при опресняването на таблицата с продукти!\nВъзможно е добавянето на нов продукт да не е било успешно.";
			}
			
			CELLS = newCells;
			
			currentModel.fireTableCellUpdated(CELLS.length, 0); //visual optimized refresh
			currentModel.fireTableCellUpdated(CELLS.length, 1);
			currentModel.fireTableCellUpdated(CELLS.length, 2);
			
			noDataInTheCells = false;
		}
		else {
			
			errorMessage = "Грешка при опресняването на таблицата с продукти!\nВъзможно е добавянето на нов продукт да не е било успешно.";			
		}
		
		return CELLS;
	}
}
